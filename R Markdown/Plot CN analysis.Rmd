---
title: "CN analysis"
author: "Chiara"
date: "September 7, 2015"
output: word_document
---

**Scope:** volumes of CN's/DN's requested online in the last 12 months

**Get data from the database:**

```
select * from fin.ProposedCnDnInvoice
where created > '2014-08-01'
```

In the CSV file downloaded from MySQL divide the column "description" between CN code and description text with Data to columns. 
Save the new file as "CNanalysis.csv" 

**Read the file into R and get a feel of the data**

```{r}
cn = read.csv("C:/Users/cdiloreto/Google Drive/Programming/Data sets and exercises/WORK stuff/CNanalysis.csv")
View(cn)
names(cn)
str(cn)
```

**Load ggplot2**

```{r}
library(ggplot2)
qplot(data = cn, x = status)
```

**Change order of the levels and plot again**

```{r}
cn$status = factor(cn$status, levels = c("ready", "rejected", "approved", "pending"))
qplot(data = cn, x = status, color = I("black"), fill = I("lightgreen"), xlab = "CN's approved (ready) or rejected")
```

Check what is the ratio between approved CN's (status == "ready") and rejected CN's (status == "rejected")

```{r}
nrow(subset(cn, status == "ready"))
nrow(subset(cn, status == "rejected"))
hitrate = nrow(subset(cn, status == "rejected")) / nrow(subset(cn, status == "ready"))
percentage = round((nrow(subset(cn, status == "rejected"))/nrow(subset(cn, status == "ready"))) ** 100, 1)
hitrate
percentage
```

**Isolate rejected CN's (the ones we want to investigate)**

```{r}
rejected = subset(cn, status == "rejected")
```

**Work on processed CN's (exclude "approved" and "pending").**
Plot how many rejections vs. approved by FA

```{r}
cnp = subset(cn, status %in% c("ready", "rejected"))
qplot(x = status, data = cnp, color = I("black"), fill = I("green"), xlab = "CN's approved (ready) or rejected")
```

###Analysis on the codes
Codes are not precise enough, so I decided to exclude everything apart from this (factor only the values I am interested in):

```{r}
cn$code = factor(cn$code, c("C13 ","CC1 ","CC2 ","CC3 ","CC4 ","CC5 ","CC6 ","CC9 ","CD1 ","CD2 ","CD3 ","CS1 ","CS2 ","CS3 ","HT1 ","HT2 ","FA3 "))
```

###Analysis on the volumes over time
First thing, we need to get a column from the table that has a time indicator, in this case last_change. 
####Format
Then we need to make sure that the column has the right format for the analysis we need to do (in this case, we are only going to need the day of last_change and don't need the time of the day)

```{r}
str(cn$last_change)
cn$last_change = as.Date(cn$last_change, "%m/%d/%Y")   ##Note the capital Y for 4-digit year format
str(cn$last_change)
```

Format object `rejected` in the same way
```{r}
rejected$last_change = as.Date(rejected$last_change, "%m/%d/%Y")
```


**QPlot the last_change column**, binwidth = 7

```{r}
qplot(x = last_change, data = cn, binwidth = 7, 
      color = I("black"), fill = I("orange"), 
      xlab = "Number of CN processed (approved or rejected) weekly")
```

**Qplot the last change for rejected CN's**, binwidth = 7


```{r}
qplot(x = last_change, data = rejected, binwidth = 7,
      color = I("black"), fill = I("pink"),
      xlab = "Number of CN rejected weekly")
```


**Alternative with ggplot**

```{r}
ggplot(cn, aes(x = last_change)) +
        geom_histogram(binwidth = 7, 
                       color = I("black"), fill = I("orange"), 
                       xlab = "Number of CN processed (approved or rejected)")
```

####Volume of rejections over time

```{r}
ggplot(rejected, aes(x = last_change)) +
        geom_histogram(binwidth = 7, 
                       color = I("black"), fill = I("pink"))
```

###this does not work
```{r}
ggplot(rejected, aes(x = last_change)) +
        geom_line()
```


**Isolate a certain period**, `DecJan` and **qplot**

```{r}
DecJan = subset(cn, last_change > "2014-12-01" & last_change < "2015-02-01")
qplot(x = last_change, data = DecJan, binwidth = 1,
        color = I("black"), fill = I("yellow")) 
```


**Last 3 months analysis**

Query the database adding one colum with dates `date(last_change)`

```
select *,date(last_change) from fin.ProposedCnDnInvoice
where created > '2015-06-01'
```
Extract data to R
```{r}
cn3 = read.csv("C:/Users/cdiloreto/Google Drive/Programming/Data sets and exercises/WORK stuff/CN analysis Jun-Sep.csv")
```

Plot volumes over 3 months
```{r}
cn3$status = factor(cn3$status, levels = c("ready", "rejected", "approved", "pending"))
qplot(data = cn3, x = status, color = I("black"), fill = I("lightgreen"), xlab = "CN's approved (ready) or rejected")
```

Rejected CN's over the last 3 months
```{r}
rejected3 = subset(cn3, status == "rejected")
```

Format last_change column
```{r}
cn3$date.last_change. = as.Date(cn3$date.last_change.)
rejected3$date.last_change. = as.Date(rejected3$date.last_change.)
```


```{r}
qplot(x = date.last_change., data = cn3, binwidth = 7, 
      color = I("black"), fill = I("orange"), 
      xlab = "Number of CN processed (approved or rejected) weekly")
```


Next: create a grid with 2 plots of two different periods in a row
## required gridExtra, which is not available for R version 3.2.2
